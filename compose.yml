services:
  solr:
    image: solr:6.3.0
    volumes:
      - data-solr-dev:/opt/solr/server/solr/mycores/
      - ./solr/config:/opt/solr/server/solr/configsets/data_driven_schema_configs
    entrypoint:
      - docker-entrypoint.sh
      - solr-precreate
      - mycore
    environment:
      - VERBOSE=yes
  db:
    image: mariadb:5.5
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: 1
      MYSQL_PASSWORD: spotlight
      MYSQL_DATABASE: spotlight
      MYSQL_USER: spotlight
    volumes:
      - db:/var/lib/mysql
      - ./config/mysql/:/etc/mysql/conf.d:Z

  redis:
    image: redis:4-alpine
    command: redis-server
    volumes:
      - redis:/data

  web:
    image: uoregon-libraries/digital-exhibits-spotlight:202212200628
    build:
      dockerfile: Dockerfile
      context: .
    volumes:
      - .:/app
    environment:
      MAIL_SERVER: example.org
      MAIL_SENDER: noreply@example.org
      URL_HOST: localhost:3000
      SOLR_URL: http://solr:8983/solr/mycore
      OD_URL: https://oregondigital.org
      REDIS_HOST: redis
      REDIS_PORT: '6379'
      ACTIVE_JOB_QUEUE_ADAPTER: sidekiq
      SIDEKIQ_ADMIN_SAFE_URLS: 'http://localhost:3000'
      MYSQL_HOST: db
      MYSQL_PASSWORD: spotlight
      MYSQL_DATABASE: spotlight
      MYSQL_USER: spotlight
    command: >
      bash -c "./build/entrypoint.sh"
    depends_on:
      - db
      - solr
      - redis

volumes:
  data-solr-dev: {}
  db: {}
  redis: {}
